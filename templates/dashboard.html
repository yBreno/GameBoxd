<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - {{ username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header class="navbar">
    <div class="logo logo-area">
        <span class="icon">üïπÔ∏è</span>
        <a href="{{ url_for('index') }}" class="logo-text">GameBoxd</a>
    </div> 
    <nav class="menu">
        <a href="{{ url_for('avaliar') }}" class="btn btn-sm">+ Avaliar Jogo</a> 
        <a href="{{ url_for('logout') }}" class="btn btn-sm">Sair</a>
    </nav>
</header>

<div class="dashboard-container">

    <aside class="dashboard-sidebar" role="complementary">
        <div class="sidebar-user">
            <div class="user-avatar">
                <img src="{{ url_for('static', filename='Icon Menine.png') }}" alt="Avatar do usu√°rio {{ username }}" class="avatar-img">
            </div>
            <h2>{{ username }}</h2>
            <p>Avaliador de Jogos</p>
        </div>
        
        <div class="sidebar-stats">
            
            <div class="stat-item">
                <span class="stat-label">Total de Avalia√ß√µes</span>
                <span class="stat-value">{{ avaliacoes|length }}</span>
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Nota M√©dia</span>
                <span class="stat-value">
                    {% set notas_validas = avaliacoes|map(attribute='nota')|select('>', 0)|list %}
                    
                    {% if notas_validas %}
                        {% set media = notas_validas|sum / notas_validas|length %}
                        {{ "%.1f"|format(media) }}
                    {% else %}
                        0.0
                    {% endif %}
                </span>
            </div>
        </div>

        <a href="{{ url_for('avaliar') }}" class="btn add-btn big" style="width: 100%; text-align: center;">
            + Avaliar Novo Jogo
        </a>
    </aside>

    <main class="dashboard-main" role="main">

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="dashboard-header">
            <h1 class="titulo-pagina">Sua Lista de Avalia√ß√µes</h1>
        </div>

        {% if not avaliacoes %}
            <div class="welcome-incentive-card">
                <p>
                    Voc√™ ainda n√£o avaliou nenhum jogo. Comece
                    <a href="{{ url_for('avaliar') }}" style="color: var(--accent); font-weight: 600;">aqui</a> a registrar seus jogos!
                </p>
                <a href="{{ url_for('avaliar') }}" class="btn big btn-primary">Avaliar Agora</a>
            </div>
        {% else %}
            <div class="cards-grid">

                {% for aval in avaliacoes %}
                <div class="review-card">

                    <div class="card-media">
                        {% set default_cover = url_for('static', filename='default_cover.svg') %}
                        {% set cover_url = aval.rawg.cover if aval.rawg and aval.rawg.cover else default_cover %}
                        <img class="cover-img" src="{{ cover_url }}" alt="Capa do Jogo: {{ aval.name }}" loading="lazy" onerror="this.onerror=null; this.src='{{ default_cover }}';">   
                        {% if aval.rawg and aval.rawg.rating is not none %}
                        <div class="rating-badge">
                            <span class="rating-num">RAWG: {{ "%.1f"|format(aval.rawg.rating) if aval.rawg.rating is number else 'N/A' }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <h3 class="card-title">{{ aval.name }}</h3>

                    <p class="card-nota rate">
                        Sua Nota: <span class="user-rate">{{ aval.nota }}</span>‚òÖ
                    </p>

                    {% if aval.comentario %}
                        <p class="card-coment" title="{{ aval.comentario }}">
                            "{{ aval.comentario|truncate(80, True, '...') }}" 
                        </p>
                    {% endif %}

                    <div class="card-meta">
                        {% if aval.valor %}
                            <span class="card-valor">
                                üí∞ <strong>Pre√ßo:</strong> {{ aval.valor }}
                            </span>
                        {% endif %}
                        {% if aval.onde %}
                            <span class="card-onde">
                                üåê <strong>Onde Joguei:</strong> {{ aval.onde }}
                            </span>
                        {% endif %}
                    </div>

                    {% if aval.rawg and aval.rawg.stores %}
                        <div class="store-buttons" aria-label="Links para lojas do jogo">
                            {% for s in aval.rawg.stores[:3] %} <a class="store-btn" href="{{ s.url }}" target="_blank" rel="noopener noreferrer" title="Comprar/Ver em {{ s.name }}">
                                    {{ s.name }}
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="card-actions">

                        <a href="{{ url_for('editar_avaliacao', avaliacao_id=aval.id) }}"
                           class="btn-edit btn-secondary">
                            ‚úèÔ∏è Editar
                        </a>
                        <form action="{{ url_for('deletar_avaliacao', avaliacao_id=aval.id) }}" method="POST" class="delete-form" onsubmit="return confirm('Tem certeza que deseja excluir a avalia√ß√£o de {{ aval.name }}?');">
                            <button type="submit" class="btn-delete btn-danger">
                                üóëÔ∏è Excluir
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </main>
</div>

</body>
</html>