<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>{{ 'Editar Avalia√ß√£o' if aval else 'Avaliar Jogo' }} | GameBoxd</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
</head>
<body>

<header class="navbar">
    <div class="logo logo-area">
        <span class="icon">üïπÔ∏è</span>
        <a href="{{ url_for('index') }}" class="logo-text">GameBoxd</a>
    </div> 
    <nav class="menu">
        <a href="{{ url_for('dashboard') }}" class="btn btn-sm">Dashboard</a> 
        <a href="{{ url_for('logout') }}" class="btn btn-sm">Sair</a>
    </nav>
</header>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages-container">
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="review-form-container">

    <aside class="review-sidebar">
        <div class="game-icon">üéÆ</div>

        <div class="stats">
            {% if aval %}
                <p><strong>Editando:</strong> {{ aval.name }}</p>
                <p>Sua nota anterior: **{{ aval.nota }}**‚òÖ</p>
            {% else %}
                <p><strong>Nova Avalia√ß√£o</strong></p>
            {% endif %}
        </div>

        <div class="sidebar-info">
            Preencha as informa√ß√µes do jogo e registre sua experi√™ncia. O nome √© importante para que possamos buscar a capa!
        </div>
    </aside>

    <main class="review-form">

        <h1>
            {% if aval %}
                Editar Avalia√ß√£o de {{ aval.name }}
            {% else %}
                Avaliar Novo Jogo
            {% endif %}
        </h1>

        <form method="POST">

            <div class="form-group">
                <label for="game-name">Nome do Jogo</label>
                <input 
                    type="text" 
                    name="name"
                    id="game-name" 
                    required
                    placeholder="Ex: Elden Ring"
                    value="{{ aval.name if aval else '' }}"
                    list="game-suggestions"
                    {% if aval %} disabled {% endif %} >
                
                <datalist id="game-suggestions"></datalist>

                {% if aval %}
                    <input type="hidden" name="name" value="{{ aval.name }}">
                    <p class="info-text">O nome do jogo n√£o pode ser alterado ap√≥s a cria√ß√£o.</p>
                {% else %}
                    <p class="info-text">Comece a digitar para buscar o nome oficial.</p>
                {% endif %}
            </div>

            <div class="form-group-row">
                <div class="form-group">
                    <label for="game-nota">Sua Nota (0.0 a 10.0)</label>
                    <input
                        type="number"
                        name="nota"
                        id="game-nota"
                        min="0"
                        max="10"
                        step="0.5"
                        required
                        value="{{ aval.nota if aval else '' }}"
                    >
                    <p class="info-text">Use 0.5 para notas intermedi√°rias.</p>
                </div>

                <div class="form-group">
                    <label for="game-valor">Valor Pago</label>
                    <input
                        type="text"
                        name="valor"
                        id="game-valor"
                        placeholder="Ex: R$ 199.99, Game Pass, Gratuito"
                        value="{{ aval.valor if aval else '' }}"
                    >
                    <p class="info-text">Opcional.</p>
                </div>
            </div>

            <div class="form-group">
                <label for="game-onde">Onde Comprou/Jogou</label>
                <input
                    type="text"
                    name="onde"
                    id="game-onde"
                    placeholder="Ex: Steam, PlayStation Store, Pirata (se for o caso)"
                    value="{{ aval.onde if aval else '' }}"
                >
                <p class="info-text">Onde voc√™ obteve o jogo.</p>
            </div>

            <div class="form-group">
                <label for="game-comentario">Coment√°rio</label>
                <textarea 
                    name="comentario"
                    id="game-comentario"
                    rows="5"
                    placeholder="Diga o que achou do jogo, seus pontos altos e baixos, etc."
                >{{ aval.comentario if aval else '' }}</textarea>
                <p class="info-text">Sua opini√£o completa.</p>
            </div>


            <div class="actions">

                <button type="submit" class="btn submit-btn btn-primary">
                    {% if aval %}
                        üíæ Salvar Altera√ß√µes
                    {% else %}
                        Salvar Avalia√ß√£o
                    {% endif %}
                </button>

                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary cancel-btn">
                    Cancelar
                </a>

            </div>

        </form>

    </main>
</div>

{% if not aval %}
<script>
    const nameInput = document.getElementById('game-name');
    const dataList = document.getElementById('game-suggestions');
    let searchTimeout;

    // Busca sugest√µes na API
    const fetchSuggestions = (query) => {
        // Verifica se a query tem pelo menos 3 caracteres
        if (query.length < 3) {
            dataList.innerHTML = ''; // Limpa as sugest√µes se for muito curto
            return;
        }

        // Usa o endpoint Flask que se comunica com a RAWG
        const url = `/api/search_game?q=${encodeURIComponent(query)}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                dataList.innerHTML = ''; // Limpa as sugest√µes antigas
                
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    dataList.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar sugest√µes da RAWG:', error);
            });
    };

    // Evento de digita√ß√£o com Debounce
    nameInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);
        
        // Espera 300ms ap√≥s a √∫ltima digita√ß√£o (debounce)
        searchTimeout = setTimeout(() => {
            fetchSuggestions(query);
        }, 300);
    });
</script>
{% endif %}
</body>
</html>